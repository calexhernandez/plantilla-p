var xml = new XML(connectorMessage.getRawData());
var obrList = xml..OBR;  // Todos los OBRs
var obxList = xml..OBX;  // Todos los OBXs
var results = [];

var obxIndex = 0;

for (var i = 0; i < obrList.length(); i++) {
    var obr = obrList[i];
    var profileName = obr['OBR.4']['OBR.4.2'].toString(); // Por ejemplo: "Cloro", puede variar según tu estructura

    var count = 0;
    // Recorremos los OBX desde el actual índice
    while (obxIndex < obxList.length()) {
        var obx = obxList[obxIndex];
        // ¿Está este OBX antes del siguiente OBR?
        if (i < obrList.length() - 1) {
            // Si hay otro OBR, comparamos la posición
            if (obx.childIndex() < obrList[i + 1].childIndex()) {
                count++;
                obxIndex++;
            } else {
                break;
            }
        } else {
            // Último OBR, cuenta todos los OBX restantes
            count++;
            obxIndex++;
        }
    }

    results.push({
        perfil: profileName,
        cantidad_obx: count
    });
}

// Resultado final
for each (var res in results) {
    logger.info("Perfil: " + res.perfil + ", OBX count: " + res.cantidad_obx);
}
