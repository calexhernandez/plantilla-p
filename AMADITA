package org.example;

import io.socket.client.IO;
import io.socket.client.Socket;
import io.socket.emitter.Emitter;
import org.json.JSONArray;
import org.json.JSONObject;

import java.net.URISyntaxException;
import java.util.HashMap;
import java.util.Map;

public class SocketClient {

    private Socket socket;

    public void connect(String url, String username, String password) throws URISyntaxException {
        IO.Options options = new IO.Options();
        options.transports = new String[]{"websocket"};

        Map<String, String> auth = new HashMap<>();
        auth.put("username", username);
        auth.put("password", password);
        options.auth = auth;

        socket = IO.socket(url, options);

        socket.on(Socket.EVENT_CONNECT, args -> {
            System.out.println("‚úÖ Conectado al servidor");
        });

        socket.on(Socket.EVENT_CONNECT_ERROR, args -> {
            System.out.println("‚ùå Error de conexi√≥n:");
            for (Object arg : args) {
                System.out.println(" - " + arg);
            }
        });

        socket.on(Socket.EVENT_CONNECT_TIMEOUT, args -> {
            System.out.println("‚è∞ Timeout al conectar");
        });

        socket.on(Socket.EVENT_ERROR, args -> {
            System.out.println("‚ö†Ô∏è Error general:");
            for (Object arg : args) {
                System.out.println(" - " + arg);
            }
        });

        socket.on(Socket.EVENT_DISCONNECT, args -> {
            System.out.println("üîå Desconectado del servidor");
        });

        socket.on("order_sent", args -> {
            System.out.println("üì© Respuesta recibida:");
            for (Object arg : args) {
                System.out.println(" - " + arg);
            }
        });

        socket.connect();
    }

    public void sendOrder(JSONObject payload) {
        if (socket != null && socket.connected()) {
            socket.emit("send_order", payload);
            System.out.println("üì§ Evento 'send_order' enviado");
        } else {
            System.out.println("‚ùå No conectado, no se puede enviar");
        }
    }

    public void disconnect() {
        if (socket != null) {
            socket.disconnect();
            socket.close();
            System.out.println("üîå Desconectado manualmente");
        }
    }

    public static JSONObject crearPayloadDemo() {
        JSONObject payload = new JSONObject()
                .put("requestNumber", 99009901)
                .put("accountNumber", 0)
                .put("patientNumber", 0)
                .put("cedula", "402-1115792-6")
                .put("email", "angel.perez@amadita.com")
                .put("isCompleted", false)
                .put("totalProcedures", 20)
                .put("totalPendingProcedures", 20)
                .put("locationId", "2023")
                .put("patientId", JSONObject.NULL)
                .put("resultNumber", 99009901)
                .put("origen", "SOCKET-CORE4ALL");

        JSONArray tests = new JSONArray();
        tests.put(new JSONObject()
                .put("priority", 0)
                .put("flagInfectiousDisease", 0)
                .put("averageDate", "2021-09-19")
                .put("averageHour", "10:59:00.0000000")
                .put("flagAbnormal", 0)
                .put("procNumber", 1)
                .put("description", "Blood")
                .put("result", "base64")
                .put("hl7Result", "lorem")
                .put("statusRequest", "C")
                .put("statusResult", "C"));

        payload.put("tests", tests);
        return payload;
    }
}
