from flask import Flask, request, jsonify
import socketio
import threading

app = Flask(__name__)

# âš™ï¸ ConfiguraciÃ³n del WebSocket
SOCKET_URL = 'http://socket-handle-tests.amaditaplayground.com:30008'  # Cambia por el host real
USERNAME = 'employees.consultor'
PASSWORD = 'gVh6#1TSyPt2'

# Cliente Socket.IO persistente
sio = socketio.Client()

# Eventos WebSocket
@sio.event
def connect():
    print("âœ… WebSocket conectadoo")

@sio.event
def disconnect():
    print("ğŸ”Œ WebSocket desconectado")

@sio.event
def connect_error(data):
    print("âŒ Error de conexiÃ³n:", data)

@sio.on("order_sent")
def on_order_sent(data):
    print("ğŸ“© Respuesta desde WebSocket:")
    print(data)

# ConexiÃ³n WebSocket en un hilo separado para no bloquear Flask
def conectar_websocket():
    try:
        sio.connect(
            SOCKET_URL,
            transports=['websocket'],
            auth={'username': USERNAME, 'password': PASSWORD}
        )
        sio.wait()  # Mantiene la conexiÃ³n abierta
    except Exception as e:
        print("âŒ Fallo al conectar al WebSocket:", str(e))

# Iniciar conexiÃ³n WebSocket en segundo plano
threading.Thread(target=conectar_websocket, daemon=True).start()

# âœ… Ruta HTTP para Mirth
@app.route('/receive', methods=['POST'])
def recibir_desde_mirth():
    payload = request.get_json()
    if not payload:
        return jsonify({'error': 'No se recibiÃ³ JSON'}), 400

    print("ğŸ“¥ JSON recibido de Mirth:")
    print(payload)

    if sio.connected:
        sio.emit("send_order", payload)
        print("ğŸ“¤ Enviado a WebSocket")
        return jsonify({'status': 'enviado'}), 200
    else:
        print("âŒ WebSocket no conectado")
        return jsonify({'error': 'WebSocket no conectado'}), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=4000)
    
