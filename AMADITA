var raw = message;  // mensaje HL7 como string
var lines = raw.split('\n');  // separar líneas

var results = [];
var currentObr = null;
var currentObxCount = 0;

for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim();
    
    if (line.startsWith("OBR|")) {
        // Si ya teníamos un OBR anterior, guardamos su conteo
        if (currentObr != null) {
            results.push({ obr: currentObr, obxCount: currentObxCount });
        }
        // Iniciar nuevo conteo
        var obrFields = line.split("|");
        currentObr = obrFields[4];  // por ejemplo: QC6P^Calcio en Orina 24 Horas^MODULAB
        currentObxCount = 0;
    } else if (line.startsWith("OBX|")) {
        currentObxCount++;
    }
}

// No olvides guardar el último OBR
if (currentObr != null) {
    results.push({ obr: currentObr, obxCount: currentObxCount });
}

// Imprimir resultados
for (var j = 0; j < results.length; j++) {
    logger.info("Perfil: " + results[j].obr + " -> OBX encontrados: " + results[j].obxCount);
}
