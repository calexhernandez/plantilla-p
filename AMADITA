// Inicializar el objeto JSON
var json = {
  PeticionModulab: '',
  NumeroRequisicionPedido: '',
  FechaPeticion: '',
  IDPrincipalActual: '',
  FechaNacimiento: '',
  EstadoOrden: 'Con Resultado',
  Procedimientos: []
};

// Extraer informaciÃ³n del mensaje HL7
json.PeticionModulab = msg['ORC']['ORC.3']['ORC.3.1'].toString();
json.NumeroRequisicionPedido = msg['ORC']['ORC.4']['ORC.4.1'].toString();
json.FechaPeticion = msg['MSH']['MSH.7']['MSH.7.1'].toString().substring(0,8);
json.IDPrincipalActual = msg['PID']['PID.3']['PID.3.2'].toString();
json.FechaNacimiento = msg['PID']['PID.7']['PID.7.1'].toString().substring(0,8);

// Procesar los segmentos OBR y OBX
for each (var obr in msg.getSegments('OBR')) {
  var procedimiento = {
    Procedimiento: '',
    perfil: '',
    IDProcedimiento: '',
    Procedimiento: '',
    Estatus: 'Validado',
    pruebas: []
  };
  
  procedimiento.IDProcedimiento = obr['OBR.4']['OBR.4.1'].toString();
  procedimiento.Procedimiento = obr['OBR.4']['OBR.4.2'].toString();
  
  // Verificar si hay segmentos OBX asociados
  var obxSegments = msg.getSegmentsAfter('OBX', obr);
  if (obxSegments.length > 0) {
    // Es un perfil con pruebas
    procedimiento.perfil = procedimiento.IDProcedimiento;
    for each (var obx in obxSegments) {
      var prueba = {
        prueba: obx['OBX.3']['OBX.3.1'].toString(),
        IDProcedimiento: obx['OBX.3']['OBX.3.1'].toString(),
        Procedimiento: obx['OBX.3']['OBX.3.2'].toString(),
        Estatus: 'Validado'
      };
      procedimiento.pruebas.push(prueba);
    }
  } else {
    // Es una prueba individual
    procedimiento.prueba = procedimiento.IDProcedimiento;
  }
  
  json.Procedimientos.push(procedimiento);
}

// Convertir el objeto JSON a cadena
var jsonString = JSON.stringify(json, null, 2);

// Asignar la cadena JSON al mensaje de salida
message = jsonString;
