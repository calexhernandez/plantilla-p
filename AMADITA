var xml = msg;

var obrList = xml..OBR;
var obxList = xml..OBX;

var results = [];

var obxIndex = 0;

for (var i = 0; i < obrList.length(); i++) {
    var obr = obrList[i];
    var peticionModulab = obr['OBR.3']['OBR.3.1'].toString();
    
    var numeroRequisicionPedido = obr['OBR.2'].toString();
    logger.info("Requi: " +numeroRequisicionPedido);
    var id = obr['OBR.4']['OBR.4.1'].toString(); // Ajusta si es otro campo
    var profileName = obr['OBR.4']['OBR.4.2'].toString(); // Ajusta si es otro campo
    var idPrincipalActual =  msg['PID']['PID.3'][1]['PID.3.1'].toString();
    var fechaNacimiento = msg['PID']['PID.7']['PID.7.1'].toString();
    var fechaPeticion = msg['MSH']['MSH.7']['MSH.7.1'].toString();
    
    var obxItems = [];

    while (obxIndex < obxList.length()) {
        var obx = obxList[obxIndex];

        // Si no es el último OBR, verifica si este OBX está antes del siguiente OBR
        if (i < obrList.length() - 1) {
            if (obx.childIndex() < obrList[i + 1].childIndex()) {
                // Extraemos datos del OBX
                var testCode = obx['OBX.3']['OBX.3.1'].toString();
                var value = obx['OBX.5'].toString();
                var unit = obx['OBX.6']['OBX.6.1'].toString();

                obxItems.push({
                    codigo: testCode,
                    valor: value,
                    unidad: unit
                });

                obxIndex++;
            } else {
                break;
            }
        } else {
            // Último OBR: toma todos los OBX restantes
            var testCode = obx['OBX.3']['OBX.3.1'].toString();
            var value = obx['OBX.5'].toString();
            var unit = obx['OBX.6']['OBX.6.1'].toString();

            obxItems.push({
                codigo: testCode,
                valor: value,
                unidad: unit
            });

            obxIndex++;
        }
    }

    results.push({
    	   peticionModulab1: peticionModulab,
    	   numeroRequisicionPedido1: numeroRequisicionPedido,
    	   fechaNacimiento: fechaNacimiento,
    	   fechaPeticion:fechaPeticion,
    	   idPrincipalActual: idPrincipalActual,
    	   codigo: id,
        perfil: profileName,
        fechaNacimiento: fechaNacimiento,
        obx: obxItems
    });
}

// Si quieres imprimirlo en logger:
for each (var r in results) {
    logger.info("Perfil: " + r.perfil + " Codigo: "+r.codigo);
    for each (var o in r.obx) {
        logger.info("  -> Código: " + o.codigo + ", Valor: " + o.valor + ", Unidad: " + o.unidad);
        logger.info("peticion modulab" + r.peticionModulab1);
        logger.info("numero Requisicion Pedido" + r.numeroRequisicionPedido1);
    }
}
