filtro

*********

if ((msg['MSH']['MSH.9']['MSH.9.1'].toString() == "OML") && (msg['MSH']['MSH.9']['MSH.9.2'].toString() == "O21"))
{
    return true;
}
else if ((msg['MSH']['MSH.9']['MSH.9.1'].toString() == "ORU") && (msg['MSH']['MSH.9']['MSH.9.2'].toString() == "R01"))
{
	
	if ((msg['ORC'][0]['ORC.5']['ORC.5.1'].toString() == "CM") && (msg['OBR'][0]['OBR.25']['OBR.25.1'].toString() == "F"))
	{
		return true;
	}

	return false;
	
}
return false;

****


tranformador
JWT1.1
******

var Base64 = Packages.java.util.Base64;
var Algorithm = Packages.com.auth0.jwt.algorithms.Algorithm;
var JWT = Packages.com.auth0.jwt.JWT;

//var idcard = msg['PID']['PID.3']['PID.3.1'].toString()



if(getArrayOrXmlLength(msg['PID']['PID.3']) > 1){
	//cuando viene mas de un identificador
	for (var i = 0; i < getArrayOrXmlLength(msg['PID']['PID.3']); i++) {
		if (msg['PID']['PID.3'][i]['PID.3.5'].toString() == "PI") {
			
			var idcard = msg['PID']['PID.3'][i]['PID.3.1'].toString()
		}
		
	}
}else{
	//logger.info("else")
	if (msg['PID']['PID.3']['PID.3.5'].toString() == "PI") {
		
		var idcard = msg['PID']['PID.3']['PID.3.1'].toString()
	}
}


if(getArrayOrXmlLength(msg['PID']['PID.3']) > 1){
	//cuando viene mas de un identificador
	for (var i = 0; i < getArrayOrXmlLength(msg['PID']['PID.3']); i++) {
		if (msg['PID']['PID.3'][i]['PID.3.5'].toString() == "PPN") {
			
			var patientexternalid = msg['PID']['PID.3'][i]['PID.3.1'].toString()
		}
		
	}
}else{
	//logger.info("else")
	if (msg['PID']['PID.3']['PID.3.5'].toString() == "PPN") {
		
		var patientexternalid = msg['PID']['PID.3']['PID.3.1'].toString()
	}
	
}

var base64Key = configurationMap.get('base64key')
var secretKeyBytes = Base64.getDecoder().decode(base64Key);


var signingKey = Algorithm.HMAC256(secretKeyBytes);

// Create a JWT token
var token = JWT.create()
    //.withIssuer("mirth")
    .withClaim("idcard", patientexternalid)
    .withClaim("username", "SIGMA")
    .sign(signingKey);



channelMap.put('idcard',idcard);
channelMap.put('externalId',patientexternalid);
channelMap.put('token',token);

//logger.info(token)
//logger.info(headerEncoded + "." + payloadEncoded + "." + signingKey)

****

Destination
response
XML requestId
*******

requests = msg['REQUESTLIST']['REQUEST']
contador = getArrayOrXmlLength(requests)



for (var i=0; i < contador; i++){
	//logger.info(i)
	requestLabel = msg['REQUESTLIST']['REQUEST'][i]['REQUESTLABEL'].toString()
	
	if(requestLabel == $('requestLabel')){
		//logger.info('encontrado')	
		
		email = msg['REQUESTLIST']['REQUEST'][i]['PATIENT']['EMAIL'].toString()
		doctorMail = msg['REQUESTLIST']['REQUEST'][i]['DOCTOREMAIL'].toString()
		requestId = msg['REQUESTLIST']['REQUEST'][i]['REQUESTID'].toString()
		
		i=contador
		//se usara el del portal o no se usara.
		//channelMap.put('doctorMail', doctorMail);
		channelMap.put('email', email);
		channelMap.put('requestId',requestId);
	}
	
}
******


Oru inovapar

******

var institucion = "82" + "M"
var nombreInstitucion = "CLINICA AZUERO"


tmp['MSH']['MSH.3']['MSH.3.1'] = msg['MSH']['MSH.3']['MSH.3.1'].toString()
tmp['MSH']['MSH.4']['MSH.4.1'] = msg['MSH']['MSH.4']['MSH.4.1'].toString()
tmp['MSH']['MSH.5']['MSH.5.1'] = msg['MSH']['MSH.5']['MSH.5.1'].toString()
tmp['MSH']['MSH.6']['MSH.6.1'] = msg['MSH']['MSH.6']['MSH.6.1'].toString()



// requeridos
//MSH
tmp['MSH']['MSH.7']['MSH.7.1'] = msg['MSH']['MSH.7']['MSH.7.1'].toString()
tmp['MSH']['MSH.9']['MSH.9.1'] = msg['MSH']['MSH.9']['MSH.9.1'].toString()
tmp['MSH']['MSH.9']['MSH.9.2'] = msg['MSH']['MSH.9']['MSH.9.2'].toString()
tmp['MSH']['MSH.9']['MSH.9.3'] = msg['MSH']['MSH.9']['MSH.9.3'].toString()

tmp['MSH']['MSH.10']['MSH.10.1'] = msg['MSH']['MSH.10']['MSH.10.1'].toString() 
tmp['MSH']['MSH.11']['MSH.11.1'] = msg['MSH']['MSH.11']['MSH.11.1'].toString()
tmp['MSH']['MSH.12']['MSH.12.1'] = msg['MSH']['MSH.12']['MSH.12.1'].toString()

//PID

tmp['PID']['PID.1']['PID.1.1'] = "1"
//prefijo 82 -- paciente colocar si se desea que se vea solo en esa compaÃ±ia
//es el mismo idcard
tmp['PID']['PID.2']['PID.2.1'] = $('externalId')
if($('idcard')!="undefined"){tmp['PID']['PID.3']['PID.3.1'] = $('idcard')}
tmp['PID']['PID.5']['PID.5.1'] = msg['PID']['PID.5']['PID.5.1'].toString()
tmp['PID']['PID.5']['PID.5.2'] = msg['PID']['PID.5']['PID.5.2'].toString()
tmp['PID']['PID.7']['PID.7.1'] = msg['PID']['PID.7']['PID.7.1'].toString()
tmp['PID']['PID.8']['PID.8.1'] = msg['PID']['PID.8']['PID.8.1'].toString()


if(getArrayOrXmlLength(msg['PID']['PID.13']) > 1){
	for (var i = 0; i < getArrayOrXmlLength(msg['PID']['PID.13']); i++) {
		if (msg['PID']['PID.13'][i]['PID.13.3'].toString() == "Internet" && i == 1) {
			//delete msg['PID']['PID.13'][0];
			tmp['PID']['PID.13'][0]['PID.13.4'] = msg['PID']['PID.13'][1]['PID.13.4'].toString()
			
		}
	}
}else{
	//logger.info("else")
	tmp['PID']['PID.13']['PID.13.4'] = msg['PID']['PID.13']['PID.13.4'].toString()
}

//**********


for (var i = 0; i < getArrayOrXmlLength(msg['ORC']); i++) {

	//creo xml
		    if (typeof(tmp) == 'xml') {
		        if (typeof(tmp['ORC'][i]) == 'undefined') {
		            createSegment('ORC', tmp, i);
		        }
		        if (typeof(tmp['OBR'][i]) == 'undefined') {
		            createSegment('OBR', tmp, i);
		        }
		        

		    } else {
		        if (typeof(tmp) == 'undefined') {
		            tmp = {};
		        }
		        if (typeof(tmp['ORC']) == 'undefined') {
		            tmp['ORC'] = [];
		        }
		        if (typeof(tmp['OBR']) == 'undefined') {
		            tmp['OBR'] = [];
		        }
		        
		        
		        if (typeof(tmp['ORC'][i]) == 'undefined') {
		            tmp['ORC'][i] = {};
		        }
		        if (typeof(tmp['OBR'][i]) == 'undefined') {
		            tmp['OBR'][i] = {};
		        }
		    }
	//creacion fin
		
	//ORC
	tmp['ORC'][i]['ORC.1']['ORC.1.1'] = msg['ORC'][i]['ORC.1']['ORC.1.1'].toString()
	tmp['ORC'][i]['ORC.2']['ORC.2.1'] = $('requestId')
	tmp['ORC'][i]['ORC.3']['ORC.3.1'] =  msg['ORC'][i]['ORC.3']['ORC.3.1'].toString()

	//no esta en la doc , pero se debe agregar
	tmp['ORC'][i]['ORC.5']['ORC.5.1'] = msg['ORC'][i]['ORC.5']['ORC.5.1'].toString()
	
	tmp['ORC'][i]['ORC.9']['ORC.9.1'] = msg['ORC'][i]['ORC.9']['ORC.9.1'].toString()
	tmp['ORC'][i]['ORC.15']['ORC.15.1'] = msg['ORC'][i]['ORC.15']['ORC.15.1'].toString()
								
	//no se ocupara aseguradora
	//tmp['ORC'][i]['ORC.21']['ORC.21.1'] = msg['ORC'][i]['ORC.21']['ORC.21.1'].toString()
	
	//OBR
	tmp['OBR'][i]['OBR.1']['OBR.1.1'] =msg['OBR'][i]['OBR.1']['OBR.1.1'].toString()
	//prefijo 82 -- servicio
	tmp['OBR'][i]['OBR.4']['OBR.4.1'] =  msg['OBR'][i]['OBR.4']['OBR.4.1'].toString()
	tmp['OBR'][i]['OBR.4']['OBR.4.2'] =msg['OBR'][i]['OBR.4']['OBR.4.2'].toString()
	//prefijo 82 --institucion
	tmp['OBR'][i]['OBR.10']['OBR.10.1'] = institucion + "^" + nombreInstitucion
	//prefijo 82 -- medico
	tmp['OBR'][i]['OBR.16']['OBR.16.1'] =  msg['OBR'][i]['OBR.16']['OBR.16.1'].toString()
	//tmp['OBR'][i]['OBR.16']['OBR.16.2'] = msg['OBR'][i]['OBR.16']['OBR.16.2'].toString() + "^^^^^^^^^^^^^^&" +  $('doctorMail')
	tmp['OBR'][i]['OBR.16']['OBR.16.2'] = msg['OBR'][i]['OBR.16']['OBR.16.2'].toString() + "^^^^^^^^^^^^^^&"
	
	tmp['OBR'][i]['OBR.17']['OBR.17.1'] = ""
	tmp['OBR'][i]['OBR.18']['OBR.18.1'] = ""
	tmp['OBR'][i]['OBR.19']['OBR.19.1'] = ""
	tmp['OBR'][i]['OBR.20']['OBR.20.1'] = ""
	tmp['OBR'][i]['OBR.21']['OBR.21.1'] = ""
	tmp['OBR'][i]['OBR.22']['OBR.22.1'] = ""
	tmp['OBR'][i]['OBR.23']['OBR.23.1'] = ""
	tmp['OBR'][i]['OBR.24']['OBR.24.1'] = ""
	tmp['OBR'][i]['OBR.25']['OBR.25.1'] = ""
	tmp['OBR'][i]['OBR.26']['OBR.26.1'] = ""
	tmp['OBR'][i]['OBR.27']['OBR.27.1'] = ""
	tmp['OBR'][i]['OBR.28']['OBR.28.1'] = ""
	
	
}


*******




